---
title: "Entanglements"
author: "Sam Woodman"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Goal: Examine monthly risk histograms relative to entanglement report locations. Use lookback window to account for the uncertainty in when the actual entanglement occurred.

```{r, message=FALSE}
library(gridExtra)
library(lubridate)
library(readxl)
library(tidyverse)

source("Whale_risk_timeseries_funcs.R")
source("User_script_local.R")

if (user == "JS") {
  file.ent
  
} else if (user == "SMW") {
  file.ent <- "../raimbow-local/Data/Entanglements/Entanglements_known_gear_set_location.xlsx"
  path.rdata <- "../raimbow-local/RDATA_files/"
  path.plots <- "../raimbow-local/Plots/Entanglements_timeseries/"
  
} else {
  stop("User not recognized")
}

```

## Data import and processing

Read in entanglement data, and select relevant columns. Then assign each entanglement to a region, using Gear_Set_County to determine region.

```{r}
### Make data frame relating regions and counties
# reg.names <- c("CA-S", "CA-SCen", "CA-Cen", "CA-N", "OR", "WA")
# reg.bound <- c(32.5, 34.4, 36.3, 38.76683, 42, 46.25, 50)
# 
# reg.bound <- c(
#   42, 41.5, 40, 38.83, 38.3, 
#   37.8, 37.7, 37.1, 36.83, 35.8, 
#   35, 34.375, 34, 33.75, 33.35, 
#   32.5
# )

# Monterey definitely has some area in CA-SCen too
reg.list <- list(
  "Del_Norte" = "CA-N", "Humboldt" = "CA-N", "Mendocino" = "CA-N", 
  "Sonoma" = "CA-Cen", "Marin" = "CA-Cen", "San_Francisco" = "CA-Cen",
  "San_Mateo" = "CA-Cen", "Santa_Cruz" = "CA-Cen", "Monterey" = "CA-Cen", 
  "San_Luis_Obispo" = "CA-SCen", "Santa_Barbara" = "CA-SCen", 
  "Ventura" = "CA-S", "Los_Angeles" = "CA-S", "Orange" = "CA-S", 
  "San_Diego" = "CA-S"
)

county.reg <- data.frame(region = t(as.data.frame(reg.list)), 
                         stringsAsFactors = FALSE) %>% 
  rownames_to_column(var = "county") %>% 
  mutate(county = gsub("_", " ", county, ))


### Get year-month factor levels
ym.levels <- tibble(
  year = c(rep(2009, 2), sapply(2010:2017, rep, 12), rep(2018, 7)),
  month = sprintf("%02d", c(11, 12, rep(1:12, 8), 1:7))
) %>% 
  mutate(ym = paste(year, month, sep = "-"))


### Read in and process entanglement data
x.orig <- read_xlsx(file.ent)

x <- x.orig %>% 
  select(CaseID, Year, Month, Report_Lat, Report_Long, Report_County, 
         Gear_Set_County, Gear_Set_Location_State, Timing) %>% 
  left_join(county.reg, by = c("Gear_Set_County" = "county")) %>% 
  mutate(Gear_Set_County = as.factor(Gear_Set_County), 
         region = factor(region, levels = c("WA", "OR", "CA-N", "CA-Cen", "CA-SCen")), 
         ym = factor(paste(Year, sprintf("%02d", Month), sep = "-"), levels = ym.levels$ym), 
         ym_date = parse_date_time(ym, "ym")) %>% 
  filter(!is.na(ym))



# x.summ <- x %>% 
#   mutate(ym = factor(ym, levels = x.ym.levels$ym)) %>% 
#   group_by(ym)
```

Make time series of the entanglement reports

```{r, fig.height=4, fig.width=10}
x.max <- length(levels(x$ym))
x.lab.idx <- seq(1, to = x.max, by = 3)
x.lab <- sort(levels(x$ym))[x.lab.idx]
vert.lines <- seq(0.5, to = x.max, by = 12)

ggplot(x, aes(x = ym, fill = region)) + 
  geom_bar() + 
  geom_vline(xintercept = vert.lines, col = "black", lwd = 0.35) + 
  scale_fill_brewer(palette = "Set1", name = "Region", drop = FALSE) + 
  ggtitle("CA DC confirmed and known-set-location entanglement reports") +
  xlab("Year-Month") +
  ylab("Entanglements") +
  scale_x_discrete(drop = FALSE, breaks = x.lab) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, vjust = 0.4),
        legend.justification = "top")

ggsave(paste0(path.plots, "Ent_report_timeseries.png"), height = 4, width = 10)
```

## Compare entanglement reports with risk time series values

Now we load the time series data, and plot histograms of the risk time series values (densities) by region. Then we can make the smae plots, but color-coded to indicate if there was an entanglement report during that year-month.

```{r, fig.width=14, fig.height=8}
load(paste0(path.rdata, "Whale_risk_timeseries.Rdata"))

### Add entanglement data to time series data
all.df.summ.join <- all.df.summ %>% 
  mutate(region = factor(region, levels = levels(x$region))) %>% 
  select(ym, region, risk_sum_dens)

y <- x %>% 
  group_by(ym, region) %>%
  summarise(e_count = n()) %>%
  ungroup() %>% 
  right_join(all.df.summ.join, by = c("ym", "region")) %>%
  replace_na(list(e_count = 0)) %>%
  mutate(e_count_fac = factor(e_count), 
         e_count_any = e_count > 0, 
         ym = factor(ym), 
         region = factor(region, levels(x$region)))


# Plot histogram of time series risk values
ggplot(all.df.summ, aes(x = risk_sum_dens)) +
  geom_histogram(binwidth = 0.01) +
  facet_grid(cols = vars(region)) + 
  xlab("Risk") + 
  ggtitle("Risk time series")

ggsave(paste0(path.plots, "Risk_hist_all.png"), height = 8, width = 14)


# Plot histogram of time series risk values, color-coded by whether or not there was an entanglement
y %>% 
  filter(region %in% c("CA-N", "CA-Cen", "CA-SCen")) %>%
  ggplot(aes(x = risk_sum_dens, fill = e_count_fac)) + 
  geom_histogram(binwidth = 0.01, position = "stack") +
  facet_grid(cols = vars(region)) + 
  guides(fill = guide_legend(title = "Entanglement count")) + 
  xlab("Risk") + 
  ggtitle("Risk time series with entanglement reports - original (actual) report timing")

ggsave(paste0(path.plots, "Risk_hist_orig.png"), height = 8, width = 14)
```

## Compare entanglement reports with risk time series values - pt2

Now, we wish to take into account the fact that we do not know exactly when the entanglement occurred. To do this, we use a 'lookback window', meaning we look back at the maximum risk value that occurred in that region within the past 1 month, 2 months, etc. 

TODO: we also want to look at the sum of the risk values that occurred in that region within the lookback window, but not sure yet how to make a meaningful plot.

```{r, fig.width=14, fig.height=8}
# Set size of lookback window
# lookback.mons <- 3

# Loop through possible lookback windows
for (lookback.mons in 0:12) {
  # Prep entanglement records - add idx column
  x.pre <- x %>% 
    select(region, ym_date) %>% 
    mutate(idx = seq_along(ym_date))
  
  # Get all ym values in lookback window, determine which ym value has max 
  x2 <- lapply(0:lookback.mons, function(i) {
    x.pre %>% 
      mutate(ym_date_curr = ym_date %m-% months(i), 
             ym_curr = substr(as.character(ym_date_curr), 1, 7))
  }) %>% 
    bind_rows() %>% 
    select(region, ym = ym_curr, idx) %>% 
    left_join(all.df.summ.join, by = c("ym", "region")) %>% 
    group_by(idx) %>% 
    summarise(r_max = max(risk_sum_dens, na.rm = TRUE), 
              r_sum = sum(risk_sum_dens, na.rm = TRUE), 
              ym_max = ym[which.max(risk_sum_dens)]) %>% 
    ungroup() %>% 
    right_join(x.pre, by = "idx") %>% 
    select(idx, ym = ym_max, region, r_max, r_sum)
  
  # Summarise entanglement count by max ym
  y2 <- x2 %>% 
    group_by(ym, region) %>%
    summarise(e_count = n()) %>%
    ungroup() %>% 
    right_join(all.df.summ.join, by = c("ym", "region")) %>%
    replace_na(list(e_count = 0)) %>%
    mutate(e_count_fac = factor(e_count, levels = 0:8), 
           e_count_any = e_count > 0, 
           ym = factor(ym), 
           region = factor(region, levels(x$region)))
  
  # Plot
  gg2 <- y2 %>% 
    filter(region %in% c("CA-N", "CA-Cen", "CA-SCen")) %>%
    ggplot(aes(x = risk_sum_dens, fill = e_count_fac)) + 
    geom_histogram(binwidth = 0.01, position = "stack") +
    facet_grid(cols = vars(region)) + 
    # guides(fill = guide_legend(title = "Entanglement count")) + 
    scale_fill_discrete(drop = FALSE, name = "Entanglement count") + 
    scale_y_continuous(breaks = seq(0, 100, by = 5)) +
    xlab("Risk") + 
    ggtitle(paste("Risk time series with entanglement reports -", lookback.mons, 
                  "month lookback window, max value within window"))
  
  
  # Save plot
  file.plot <- paste0(path.plots, "Risk_hist_lookback_", lookback.mons, "mons.png")
  ggsave(file.plot, gg2, height = 8, width = 14)
}
```

Experimental: for each (some?) lookback window, how far back is the max risk?

```{r}
x.out <- x.orig %>% 
  left_join(select(x, CaseID, region), by = "CaseID")

for(lookback.mons in seq(0, 12, by = 3)) {
  # Prep entanglement records - add idx column
  x.pre <- x %>% 
    mutate(idx = seq_along(ym_date))
  
  # Get all ym values in lookback window, determine which ym value has max 
  x2 <- lapply(0:lookback.mons, function(i) {
    x.pre %>% 
      mutate(ym_date_curr = ym_date %m-% months(i), 
             ym_curr = substr(as.character(ym_date_curr), 1, 7))
  }) %>% 
    bind_rows() %>% 
    select(region, ym = ym_curr, idx) %>% 
    left_join(all.df.summ.join, by = c("ym", "region")) %>% 
    group_by(idx) %>% 
    summarise(r_max = max(risk_sum_dens, na.rm = TRUE), 
              r_sum = sum(risk_sum_dens, na.rm = TRUE), 
              ym_max = ym[which.max(risk_sum_dens)]) %>% 
    ungroup() %>% 
    right_join(x.pre, by = "idx") %>% 
    select(CaseID, ym_max) %>% 
    set_names("CaseID", paste0("ym_max", lookback.mons))
  
  x.out <- left_join(x.out, x2, by = "CaseID")
}

write.csv(x.out, file = paste0(path.plots, "Ent_ymmax.csv"), row.names = FALSE)

table(x.out$ym_max0, as.character(x.out$region))
table(x.out$ym_max3, as.character(x.out$region))
table(x.out$ym_max6, as.character(x.out$region))
table(x.out$ym_max9, as.character(x.out$region))
table(x.out$ym_max12, as.character(x.out$region))
```
