title: "Tradeoff analysis results"
---
author: "Jameal Samhouri"
date: "initiated 5/22/2020, modified 6/12/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This document provides an outline of figures and tables to include in the Samhouri et al. tradeoff analysis. It is based on the presentation I gave February 5, 2020, with improvements. See google doc: https://docs.google.com/document/d/15loTrgX2H7ZIArVmTIHVTNrinvHHui03CTLo1cdlbss/edit?pli=1. Use "Full workflow for risk assessment and tradeoff analysis" google doc to prep data frames for making figures below. https://docs.google.com/document/d/1T8S5rEOACMCeGa5efS5BnEQY4gOw-PbxmvILJvShsQo/edit

Current outline of figures:

Entanglements are on the rise coastwide. Hump, blue, other entanglements by year

The CA Dungeness crab fishery revenue, landings, and vessels by year. Also do for VMS vessels only

Maps of long-term average during DCRB season of hump, blue, DCRB $, DCRB lbs, DCRB pings [DCRB do all, sm, lg]

Time series of cumulative annual (a) humpback risk, (b) blue risk, (c) DCRB revenue. Emphasizes contrasts between Statewide, region, BIAs. [DCRB do all, sm, lg].

Time series of cumulative risk and revenue by early/mid/late season (a) humpback risk, (b) blue risk, (c) DCRB revenue. Emphasizes contrasts between times of year for each metric. [DCRB do all, sm, lg]. 

Time series of cumulative risk and revenue in cenCA vs norCA, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts between regions and times of year for each metric. [DCRB do all, sm, lg]

Time series of cumulative risk and revenue in and out of BIAs, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts in and out of BIAs and times of year for each metric. [DCRB do all, sm, lg]

Maps of long-term avg full season pings for SQ, delay cenCA, early closure statewide, and delay cenCA + early closure statewide. If not contrast, revisit.

Avg risk in 2009-13 v 2014-19 for blues and humps. 

Avg $ in 2009-13 v 2014-19 for all, sm, lg DCRB.

Expected (a) risk reduction by scenario for humps v blues, (b) $ reduction by scenario for all, sm, lg DCRB. order by whales

Time series of expected (a) risk reduction by scenario for humps v blues, (b) $ reduction by scenario for all, sm, lg DCRB. order by whales

Tradeoff plots for hump, blues, both. Full time period, 2009-13, 2014-19. all, sm, lg DCRB.



```{r prep, message=FALSE}
# just getting libraries loaded and file paths sorted

library(tidyverse)
library(foreign) # read.dbf()
library(here)
library(lubridate)
library(sf)
library(viridis)
library(ggrepel)
library(magrittr)

# Note that Rmd documents set the working directory as the location of the document, rather than the project directory. 
#   Thus, please ensure that file paths are complete rather than relative

source(here::here("User_script_local.R"))
if (user == "SMW") {
  NULL
} else if (user == "JS") {
  #flag.save = TRUE # option to save all outputs or not
  
  path_entanglement_file <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Input_Data/Entanglement Data/Whale Entanglement Data/2000_19/2000_19.dbf"
  
  path_figures <- "/Users/jameal.samhouri/Dropbox/Projects/In progress/RAIMBOW/raimbow/tradeoffs/Management scenarios/figures"
  
  path_status_quo <- paste0("/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/scenario_output_dataframes/status_quo_risk_2009_2019_yr_mth_2020-06-14.rds")
    
  path_effort_shift_scenariocomparisons_annual_statewide_df_n <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/annual_statewide_effort_shift_scenariocomparisons_n_2020-05-19.rds"
  
  path_tradeoff_df_effort_shift_scenariocomparisons_n <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/tradeoff_df_effort_shift_scenariocomparisons_n_2020-05-19.rds"
  
  path_scenario_table_all <- "/Users/jameal.samhouri/Dropbox/Projects/In progress/RAIMBOW/raimbow/tradeoffs/Management scenarios/scenario_table_all_2020-06-09.rds"
  
  path_scenario_table_focal_scenarios <- "/Users/jameal.samhouri/Dropbox/Projects/In progress/RAIMBOW/raimbow/tradeoffs/Management scenarios/scenario_table_focal_scenarios_2020-06-12.rds"
  
  path_annual_statewide_df_focal_scenarios <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/annual_statewide_df_focal_scenarios_2020-06-12.rds"
  
  path_df_tradeoff_focal_scenarios <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/df_tradeoff_focal_scenarios_2020-06-12.rds"
  
  path_prioritizr_all <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/prioritizr/prioritzr_outputs_all.rds"
  

} else {
  stop("Invalid user")
}

```
<br>

## Entanglement time series

Entanglements are on the rise coastwide. Hump, blue, other entanglements by year


```{r, include=FALSE}

# most code from Make time series of entanglements.Rmd
#Initial processing
entanglement_df <- read.dbf(entanglement_file_path)
glimpse(entanglement_df)

#Subset entanglement data frame to include only blue whales  
entanglement_df_blue <- entanglement_df[which(entanglement_df$Common_Nam == "Blue Whale" | entanglement_df$Common_Nam == "Blue whale"),]

#Subset entanglement data frame to include only humpback whales 
entanglement_df_hump <- entanglement_df[which(entanglement_df$Common_Nam == "Humpback Whale"),]


#x.whale <- readRDS("/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/5x5 Grid/Grid5km_whale.rds")

```
<br>

### Get annual entanglements

Blue and humpback whales
```{r, include=FALSE}
entanglement_df_blue_annual <- entanglement_df_blue %>%
  group_by(Year) %>%
  tally()

zeroes <- data.frame(
  seq(1982,2014,1),
  rep(0,length(seq(1982,2014,1)))
)
names(zeroes) <- c("Year","n")

entanglement_df_blue_annual_complete <-rbind(zeroes, entanglement_df_blue_annual)

# Determine annual entanglement rate for humps
entanglement_df_hump_annual <- entanglement_df_hump %>%
  group_by(Year) %>%
  tally() %>%
  mutate(Year.as.date = as.Date(paste(Year, 1, 1, sep = "-")) ) %>%
  complete(Year.as.date = seq.Date(as.Date(paste(1982, 1, 1, sep = "-")), max(Year.as.date), by="year"),
           fill = list(n=0))
entanglement_df_hump_annual$Year <- ifelse(is.na(entanglement_df_hump_annual$Year),year(entanglement_df_hump_annual$Year.as.date),entanglement_df_hump_annual$Year)


```
<br>

### Determine how many humpback entanglements occurred before 2014 vs 2014-2018
```{r}

entanglement_df_hump_prepost2014 <- entanglement_df_hump_annual %>%
  mutate(prepost2014 = ifelse(Year < 2014, "pre", "post")) %>%
  group_by(prepost2014) %>%
  tally() 
entanglement_df_hump_prepost2014
  

```
<br>

### Make some figures
Time series, blue whales
```{r}

myplot <- ggplot(entanglement_df_blue_annual_complete, aes(x=Year, y=n, group=1)) + # group=1 tells ggplot that there is only 1 group
  geom_point(size=2) +
  geom_line() + 
  ylab("Number of entanglements") +
  xlab("Year") +
  #xlim(1980,2020) +
  labs(caption = "Data from NMFS WRO, Lauren Saez") +
  ggtitle("Number of Blue Whale Entanglements,\nUS West Coast") +
  #scale_x_continuous(breaks = scales::pretty_breaks(n = 10))+
  #scale_x_continuous(breaks = seq(1978,2022, by = 5)) +
  scale_x_continuous(breaks=seq(1980, 20202,5),limits=c(1980,2020))+
  theme_classic() +
  #scale_fill_manual(values=c("lightskyblue", "coral")) +
  theme(legend.title = element_blank(),
        title = element_text(size = 32),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 90),
        axis.text.y = element_text(size = 18),
        axis.title = element_text(size = 24),
        strip.text = element_text(size=18))
# print(myplot)
# #png("../RAship/vessel_profiles_final/yearly_DCRB_landings_revenue_CA_rawdat.png")
# png(paste0(root.dir, "Figures/yearly_DCRB_revenue_CA_rawdat.png"))
# print(myplot)
# dev.off()
myplot
ggsave("Figures/annual_blue_entanglements.pdf",width=10, height=8)

```
<br>

## The CA Dungeness crab fishery revenue, landings, and vessels by year. Also do for VMS vessels only

```{r}





```
<br>

## Maps of long-term average during DCRB season of hump, blue, DCRB $, DCRB lbs, DCRB pings [DCRB do all, sm, lg] 


```{r}

```
<br>

## Time series of cumulative annual (a) humpback risk, (b) blue risk, (c) DCRB revenue. Emphasizes contrasts between Statewide, region, BIAs. [DCRB do all, sm, lg].

```{r}

risk_out_sq <- read_rds(path_status_quo)
names(risk_out_sq)
glimpse(risk_out_sq)

### Function to calculate crab year
func_crab_year <- function(z) {
  # z: character; year_month
  
  stopifnot(require(lubridate))
  z.yr <- as.numeric(substr(z, 1, 4))
  z.mon <- as.numeric(substr(z, 6, 7))
  
  ifelse(
    z.mon %in% 11:12, 
    paste(z.yr, z.yr + 1, sep = "_"), paste(z.yr - 1, z.yr, sep = "_")
  )
}


# add month, crab_year, plotting_year

risk_out_sq %<>% mutate(
  month = as.numeric(substr(year_month,6,7)),
  crab_year = func_crab_year(year_month),
  plotting_year = as.numeric(substr(crab_year,6,9)),
  )
glimpse(risk_out_sq)

# summarise cumulative sum of $ and risk by crab_year
annual_risk_out_sq <- risk_out_sq %>%
  group_by(crab_year) %>%
  summarise(
    
    plotting_year = unique(plotting_year),
    DCRB_rev = sum(DCRB_rev)/10^5,
    #risk_humpback = sum(risk_humpback, na.rm=TRUE),
    n_risk_humpback = sum(n_risk_humpback, na.rm=TRUE),
    #risk_blue = sum(risk_blue, na.rm=TRUE),
    n_risk_blue = sum(n_risk_blue, na.rm=TRUE),
    
    .groups = "drop"
    ) %>%
  pivot_longer(
    cols = c(DCRB_rev, n_risk_humpback, n_risk_blue), 
    names_to = "response_metric", 
    values_to = "response"
  )
glimpse(annual_risk_out_sq)
  

# check against annual_sq <- annual_statewide_df_focal_scenarios[31:40,]

# plot normalized humpbacks, normalized blues, $

ts_sq <- ggplot(
  data = annual_risk_out_sq, 
  aes(
    x = plotting_year, 
    y= response
  )
) +
  geom_point(size=4) +
  geom_line() + 
  facet_grid(rows = vars(response_metric),
             scales = "free_y",
             labeller = as_labeller ( c(
               `DCRB_rev` = "Dungeness crab\nfishery revenue\n(cumulative $, x10^5)",
               `n_risk_blue` = "Risk to blue whales\n(cumulative, normalized)",
               `n_risk_humpback` = "Risk to humpback whales\n(cumulative, normalized)"
               ) ),
             switch = "y"
             ) + 
  scale_x_continuous(breaks = seq(2010, 2019),
                     labels = unique(annual_risk_out_sq$crab_year)) + 
  ylab("") + 
  xlab("Dungeness crab season") +
  theme_classic() +
  theme(legend.title = element_blank(),
        title = element_text(size = 26),
        legend.text = element_text(size = 20),
        legend.position = c(.15, .85),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 60),
        axis.text.y = element_text(size = 14),
        axis.title = element_text(size = 20),
        strip.text = element_text(size=14),
        strip.background = element_blank(),
        strip.placement = "left"
        )

png(paste0(path_figures, "/plot_ts_sq.png"), width = 10, height = 8, units = "in", res = 300)
ts_sq
dev.off()

# summarise cumulative sum of $ and risk by crab_year, region
annual_risk_out_sq_region <- risk_out_sq %>%
  group_by(crab_year, Region) %>%
  summarise(
    
    plotting_year = unique(plotting_year),
    DCRB_rev = sum(DCRB_rev)/10^5,
    #risk_humpback = sum(risk_humpback, na.rm=TRUE),
    n_risk_humpback = sum(n_risk_humpback, na.rm=TRUE),
    #risk_blue = sum(risk_blue, na.rm=TRUE),
    n_risk_blue = sum(n_risk_blue, na.rm=TRUE),
    
    .groups = "drop"
    ) %>%
  pivot_longer(
    cols = c(DCRB_rev, n_risk_humpback, n_risk_blue), 
    names_to = "response_metric", 
    values_to = "response"
  )
glimpse(annual_risk_out_sq_region)
  

# check against annual_sq <- annual_statewide_df_focal_scenarios[31:40,]

# plot normalized humpbacks, normalized blues, $

ts_sq_region <- ggplot(
  data = annual_risk_out_sq_region, 
  aes(
    x = plotting_year, 
    y= response
  )
) +
  geom_point(size=4) +
  geom_line(aes(linetype=Region)) + 
  facet_grid(rows = vars(response_metric),
             scales = "free_y",
             labeller = as_labeller ( c(
               `DCRB_rev` = "Dungeness crab\nfishery revenue\n(cumulative $, x10^5)",
               `n_risk_blue` = "Risk to blue whales\n(cumulative, normalized)",
               `n_risk_humpback` = "Risk to humpback whales\n(cumulative, normalized)"
               ) ),
             switch = "y"
             ) + 
  scale_x_continuous(breaks = seq(2010, 2019),
                     labels = unique(annual_risk_out_sq$crab_year)) + 
  ylab("") + 
  xlab("Dungeness crab season") +
  theme_classic() +
  theme(legend.title = element_blank(),
        title = element_text(size = 26),
        legend.text = element_text(size = 20),
        legend.position = c(.1, .95),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 60),
        axis.text.y = element_text(size = 14),
        axis.title = element_text(size = 20),
        strip.text = element_text(size=14),
        strip.background = element_blank(),
        strip.placement = "left"
        )

png(paste0(path_figures, "/plot_ts_sq_region.png"), width = 10, height = 8, units = "in", res = 300)
ts_sq_region
dev.off()

# summarise cumulative sum of $ and risk by crab_year, BIA
annual_risk_out_sq_bia <- risk_out_sq %>%
  group_by(crab_year, BIA_bm_or_mn) %>%
  summarise(
    
    plotting_year = unique(plotting_year),
    DCRB_rev = sum(DCRB_rev)/10^5,
    #risk_humpback = sum(risk_humpback, na.rm=TRUE),
    n_risk_humpback = sum(n_risk_humpback, na.rm=TRUE),
    #risk_blue = sum(risk_blue, na.rm=TRUE),
    n_risk_blue = sum(n_risk_blue, na.rm=TRUE),
    
    .groups = "drop"
    ) %>%
  pivot_longer(
    cols = c(DCRB_rev, n_risk_humpback, n_risk_blue), 
    names_to = "response_metric", 
    values_to = "response"
  )
glimpse(annual_risk_out_sq_bia)
  

# plot normalized humpbacks, normalized blues, $

ts_sq_bia <- ggplot(
  data = annual_risk_out_sq_bia, 
  aes(
    x = plotting_year, 
    y= response
  )
) +
  geom_point(size=4) +
  geom_line(aes(linetype=BIA_bm_or_mn)) + 
  facet_grid(rows = vars(response_metric),
             scales = "free_y",
             labeller = as_labeller ( c(
               `DCRB_rev` = "Dungeness crab\nfishery revenue\n(cumulative $, x10^5)",
               `n_risk_blue` = "Risk to blue whales\n(cumulative, normalized)",
               `n_risk_humpback` = "Risk to humpback whales\n(cumulative, normalized)"
               ) ),
             switch = "y"
             ) + 
  scale_x_continuous(breaks = seq(2010, 2019),
                     labels = unique(annual_risk_out_sq$crab_year)) + 
  ylab("") + 
  xlab("Dungeness crab season") +
  theme_classic() +
  theme(legend.title = element_blank(),
        title = element_text(size = 26),
        legend.text = element_text(size = 20),
        legend.position = c(.15, .25),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 60),
        axis.text.y = element_text(size = 14),
        axis.title = element_text(size = 20),
        strip.text = element_text(size=14),
        strip.background = element_blank(),
        strip.placement = "left"
        )

png(paste0(path_figures, "/plot_ts_sq_bia.png"), width = 10, height = 8, units = "in", res = 300)
ts_sq_bia
dev.off()


# # calculate average annual cumulative risk per 5km grid cell
# annual_risk_out_sq_mean_sd <- risk_out_sq %>%
#   group_by(crab_year, GRID5KM_ID) %>%
#   summarise(
#     
#     plotting_year = unique(plotting_year),
#     DCRB_rev = sum(DCRB_rev),
#     risk_humpback = sum(risk_humpback, na.rm=TRUE),
#     n_risk_humpback = sum(n_risk_humpback, na.rm=TRUE),
#     risk_blue = sum(risk_blue, na.rm=TRUE),
#     n_risk_blue = sum(n_risk_blue, na.rm=TRUE),
#     
#     .groups = "drop"
#     ) %>%
#   group_by(crab_year) %>%
#   summarise(
#     plotting_year = unique(plotting_year),
#     
#     mean_DCRB_rev = mean(DCRB_rev),
#     sd_DCRB_rev = sd(DCRB_rev),
#     
#     mean_risk_humpback = mean(risk_humpback, na.rm=TRUE),
#     sd_risk_humpback = sd(risk_humpback, na.rm=TRUE),
#     
#     mean_n_risk_humpback = mean(n_risk_humpback, na.rm=TRUE),
#     sd_n_risk_humpback = sd(n_risk_humpback, na.rm=TRUE),
#     
#     mean_risk_blue = mean(risk_blue, na.rm=TRUE),
#     sd_risk_blue = sd(risk_blue, na.rm=TRUE),
#     
#     mean_n_risk_blue = mean(n_risk_blue, na.rm=TRUE),
#     sd_n_risk_blue = sd(n_risk_blue, na.rm=TRUE),
#     
#         .groups = "drop"
#   )
# 
# glimpse(annual_risk_out_sq_mean_sd)
# 
# # attempt to plot average annual cumulative risk per 5km grid cell
# # sd is wrong metric, as risk can only range [0,1]
# ggplot(
#   data = annual_risk_out_sq_mean_sd, 
#   aes(
#     x = plotting_year, 
#     y= mean_n_risk_humpback
#   )
# ) +
#   geom_point(size=4) +
#   geom_errorbar(
#         aes(ymin = mean_n_risk_humpback - sd_n_risk_humpback, ymax = mean_n_risk_humpback + sd_n_risk_humpback),
#     width=.1
#   ) + 
#   geom_line() + 
#   scale_x_continuous(breaks = seq(2010, 2019),
#                      labels = annual_risk_out_sq$crab_year) + 
#   ylab("Mean risk to humpback whales\n(normalized)") + 
#   xlab("Dungeness crab season") +
#   theme_classic() +
#   theme(legend.title = element_blank(),
#         title = element_text(size = 26),
#         legend.text = element_text(size = 20),
#         legend.position = c(.15, .85),
#         axis.text.x = element_text(hjust = 1,size = 18, angle = 60),
#         axis.text.y = element_text(size = 18),
#         axis.title = element_text(size = 20),
#         strip.text = element_text(size=18)
#         )

ts_sq
ts_sq_region
ts_sq_bia

```
<br>

## Time series of cumulative risk and revenue by early/mid/late season (a) humpback risk, (b) blue risk, (c) DCRB revenue. Emphasizes contrasts between times of year for each metric. [DCRB do all, sm, lg]. 

```{r}

# add early/mid/late season, plotting.year
early_season_begin <- 11 # if 11, early season begins in Nov
early_season_end <- 12 # if 12, early season ends in Dec
mid_season_begin <- 1 # if 1, mid season begins in Jan
mid_season_end <- 3 # if 3, mid season ends in Mar
late_season_begin <- 4 # if 4, late season begins in Apr
late_season_end <- 7 # if 7, late season ends in Jul

risk_out_sq %<>% mutate(
  time_of_crab_year = factor(
    ifelse(month >= early_season_begin & month <= early_season_end, "Early",
                             ifelse(month >= mid_season_begin & month <= mid_season_end, "Mid",
                                    "Late")
    ),
    levels = c("Early", "Mid", "Late")
  )
)
glimpse(risk_out_sq)

# summarise cumulative sum of $ and risk by crab_year, time_period within each crab_year
annual_risk_out_sq_time_period <- risk_out_sq %>%
  group_by(crab_year, time_of_crab_year) %>%
  summarise(
    
    plotting_year = unique(plotting_year),
    DCRB_rev = sum(DCRB_rev)/10^5,
    #risk_humpback = sum(risk_humpback, na.rm=TRUE),
    n_risk_humpback = sum(n_risk_humpback, na.rm=TRUE),
    #risk_blue = sum(risk_blue, na.rm=TRUE),
    n_risk_blue = sum(n_risk_blue, na.rm=TRUE),
    
    .groups = "drop"
    ) %>%
  pivot_longer(
    cols = c(DCRB_rev, n_risk_humpback, n_risk_blue), 
    names_to = "response_metric", 
    values_to = "response"
  )
glimpse(annual_risk_out_sq_time_period)
  

# plot normalized humpbacks, normalized blues, $

ts_sq_time_of_crab_year <- ggplot(
  data = annual_risk_out_sq_time_period, 
  aes(
    x = plotting_year, 
    y= response
  )
) +
  geom_point(size=4) +
  geom_line() + 
  facet_grid(rows = vars(response_metric),
             cols = vars(time_of_crab_year),
             scales = "free_y",
             labeller = as_labeller ( c(
               `DCRB_rev` = "Dungeness crab\nfishery revenue\n(cumulative $, x10^5)",
               `n_risk_blue` = "Risk to blue whales\n(cumulative, normalized)",
               `n_risk_humpback` = "Risk to humpback whales\n(cumulative, normalized)",
               `Early` = "November-December",
               `Mid` = "January-March",
               `Late` = "April-July"
               ) ),
             switch = "y"
             ) + 
  scale_x_continuous(breaks = seq(2010, 2019),
                     labels = unique(annual_risk_out_sq$crab_year)) + 
  ylab("") + 
  xlab("Dungeness crab season") +
  theme_classic() +
  theme(legend.title = element_blank(),
        title = element_text(size = 26),
        legend.text = element_text(size = 20),
        legend.position = c(.15, .85),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 60),
        axis.text.y = element_text(size = 14),
        axis.title = element_text(size = 20),
        strip.text = element_text(size=14),
        strip.background = element_blank(),
        strip.placement = "left"
        )

png(paste0(path_figures, "/plot_ts_sq_time_of_crab_year.png"), width = 14, height = 10, units = "in", res = 300)
ts_sq_time_of_crab_year
dev.off()

ts_sq_time_of_crab_year

```
<br>

## Time series of cumulative risk and revenue in cenCA vs norCA, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts between regions and times of year for each metric. [DCRB do all, sm, lg]

```{r}

# summarise cumulative sum of $ and risk by crab_year, region, time_of_crab_year
annual_risk_out_sq_region_time_period <- risk_out_sq %>%
  group_by(crab_year, Region, time_of_crab_year) %>%
  summarise(
    
    plotting_year = unique(plotting_year),
    DCRB_rev = sum(DCRB_rev)/10^5,
    #risk_humpback = sum(risk_humpback, na.rm=TRUE),
    n_risk_humpback = sum(n_risk_humpback, na.rm=TRUE),
    #risk_blue = sum(risk_blue, na.rm=TRUE),
    n_risk_blue = sum(n_risk_blue, na.rm=TRUE),
    
    .groups = "drop"
    ) %>%
  pivot_longer(
    cols = c(DCRB_rev, n_risk_humpback, n_risk_blue), 
    names_to = "response_metric", 
    values_to = "response"
  )
glimpse(annual_risk_out_sq_region_time_period)
  

# plot normalized humpbacks, normalized blues, $

ts_sq_region_time_period <- ggplot(
  data = annual_risk_out_sq_region_time_period, 
  aes(
    x = plotting_year, 
    y= response
  )
) +
  geom_point(size=4) +
  geom_line(aes(linetype=Region)) + 
  facet_grid(rows = vars(response_metric),
             cols = vars(time_of_crab_year),
             scales = "free_y",
             labeller = as_labeller ( c(
               `DCRB_rev` = "Dungeness crab\nfishery revenue\n(cumulative $, x10^5)",
               `n_risk_blue` = "Risk to blue whales\n(cumulative, normalized)",
               `n_risk_humpback` = "Risk to humpback whales\n(cumulative, normalized)",
               `Early` = "November-December",
               `Mid` = "January-March",
               `Late` = "April-July"
               ) ),
             switch = "y"
             ) + 
  scale_x_continuous(breaks = seq(2010, 2019),
                     labels = unique(annual_risk_out_sq$crab_year)) + 
  ylab("") + 
  xlab("Dungeness crab season") +
  theme_classic() +
  theme(legend.title = element_blank(),
        title = element_text(size = 26),
        legend.text = element_text(size = 20),
        legend.position = c(.1, .95),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 60),
        axis.text.y = element_text(size = 14),
        axis.title = element_text(size = 20),
        strip.text = element_text(size=14),
        strip.background = element_blank(),
        strip.placement = "left"
        )

png(paste0(path_figures, "/plot_ts_sq_region_time_period.png"), width = 14, height = 10, units = "in", res = 300)
ts_sq_region_time_period
dev.off()

ts_sq_region_time_period

```
<br>

## Time series of cumulative risk and revenue in and out of BIAs, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts in and out of BIAs and times of year for each metric. [DCRB do all, sm, lg]

```{r}

# summarise cumulative sum of $ and risk by crab_year, region, time_of_crab_year
annual_risk_out_sq_bia_time_period <- risk_out_sq %>%
  group_by(crab_year, BIA_bm_or_mn, time_of_crab_year) %>%
  summarise(
    
    plotting_year = unique(plotting_year),
    DCRB_rev = sum(DCRB_rev)/10^5,
    #risk_humpback = sum(risk_humpback, na.rm=TRUE),
    n_risk_humpback = sum(n_risk_humpback, na.rm=TRUE),
    #risk_blue = sum(risk_blue, na.rm=TRUE),
    n_risk_blue = sum(n_risk_blue, na.rm=TRUE),
    
    .groups = "drop"
    ) %>%
  pivot_longer(
    cols = c(DCRB_rev, n_risk_humpback, n_risk_blue), 
    names_to = "response_metric", 
    values_to = "response"
  )
glimpse(annual_risk_out_sq_bia_time_period)
  

# plot normalized humpbacks, normalized blues, $

ts_sq_bia_time_period <- ggplot(
  data = annual_risk_out_sq_bia_time_period, 
  aes(
    x = plotting_year, 
    y= response
  )
) +
  geom_point(size=4) +
  geom_line(aes(linetype=BIA_bm_or_mn)) + 
  facet_grid(rows = vars(response_metric),
             cols = vars(time_of_crab_year),
             scales = "free_y",
             labeller = as_labeller ( c(
               `DCRB_rev` = "Dungeness crab\nfishery revenue\n(cumulative $, x10^5)",
               `n_risk_blue` = "Risk to blue whales\n(cumulative, normalized)",
               `n_risk_humpback` = "Risk to humpback whales\n(cumulative, normalized)",
               `Early` = "November-December",
               `Mid` = "January-March",
               `Late` = "April-July"
               ) ),
             switch = "y"
             ) + 
  scale_x_continuous(breaks = seq(2010, 2019),
                     labels = unique(annual_risk_out_sq$crab_year)) + 
  ylab("") + 
  xlab("Dungeness crab season") +
  theme_classic() +
  theme(legend.title = element_blank(),
        title = element_text(size = 26),
        legend.text = element_text(size = 20),
        legend.position = c(.1, .95),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 60),
        axis.text.y = element_text(size = 14),
        axis.title = element_text(size = 20),
        strip.text = element_text(size=14),
        strip.background = element_blank(),
        strip.placement = "left"
        )

png(paste0(path_figures, "/plot_ts_sq_bia_time_period.png"), width = 14, height = 10, units = "in", res = 300)
ts_sq_bia_time_period
dev.off()

ts_sq_bia_time_period

```
<br>


## Maps of long-term avg full season pings for SQ, delay cenCA, early closure statewide, and delay cenCA + early closure statewide. If not contrast, revisit.


```{r}

```
<br>

## Avg risk in 2009-13 v 2014-19 for blues and humps.


```{r}

```
<br>

## Avg $ in 2009-13 v 2014-19 for all, sm, lg DCRB.


```{r}

```
<br>

## Expected (a) risk reduction by scenario for humps v blues, (b) $ reduction by scenario for all, sm, lg DCRB. order by whales


```{r}


#annual_statewide_df_focal_scenarios <- read_rds(path_annual_statewide_df_focal_scenarios)
df_tradeoff_focal_scenarios <- read_rds(path_df_tradeoff_focal_scenarios)
scenario_table_all <- read_rds(path_scenario_table_all)
scenario_table_focal_scenarios <- read_rds(path_scenario_table_focal_scenarios)

#unique(sort(scenario_table_focal_scenarios$scenario_df_name)) == unique(sort(df_tradeoff_focal_scenarios$scenario_df_name))

# make nice scenario names
#unique(df_tradeoff_focal_scenarios$scenario_df_name)
df_tradeoff_focal_scenarios$pretty_scenario_names <- c(
    rep("Early Closure BIAs", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide, Early Closure BIAs", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA, Early Closure BIAs", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Status Quo", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Early Closure Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide, Early Closure Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA, Early Closure Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Early Closure CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide, Early Closure CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA, Early Closure CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Statewide 50% Effort Reduction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("CenCA 50% Effort Reduction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Statewide <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("CenCA <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Statewide 50% Effort Reduction, <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("CenCA 50% Effort Reduction, <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year)))
    )  

# consider mean_relative_hump_risk_n, which is the expected reduction in risk relative to sq for each scenario. set up for geom_boxplot
df_tradeoff_focal_scenarios_means <- df_tradeoff_focal_scenarios %>% 
  filter(pretty_scenario_names != "Status Quo") %>%
  left_join(scenario_table_focal_scenarios) %>%
  group_by(number_id, scenario_df_name) %>%
  summarise(
    mean_relative_hump_risk_n = mean(relative_hump_risk_n),
    mean_relative_blwh_risk_n = mean(relative_blwh_risk_n),
    mean_relative_both_risk_n = mean(relative_both_risk_n),
    mean_relative_dollars = mean(relative_dollars),
    
    se_relative_hump_risk_n = sd(relative_hump_risk_n)/sqrt(n()),
    se_relative_blwh_risk_n = sd(relative_blwh_risk_n)/sqrt(n()),
    se_relative_both_risk_n = sd(relative_both_risk_n)/sqrt(n()),
    se_relative_dollars = sd(relative_dollars)/sqrt(n()),
    
    .groups = "drop"
  ) %>%
  arrange(
    -mean_relative_hump_risk_n,
    -mean_relative_blwh_risk_n,
    -mean_relative_both_risk_n,
    -mean_relative_dollars
  ) %>%
  mutate(scenario_rank = row_number())

df_tradeoff_focal_scenarios_bp <- df_tradeoff_focal_scenarios %>% 
  filter(pretty_scenario_names != "Status Quo") %>%
  left_join(scenario_table_focal_scenarios) %>%
  left_join(df_tradeoff_focal_scenarios_means) %>%
  mutate(
    year = as.numeric(substr(crab_year,1,4)),
    scenario_label = if_else(year == min(year), as.character(pretty_scenario_names), NA_character_)
  ) %>%
  arrange(
    scenario_rank
  )
#View(df_tradeoff_focal_scenarios_bp)

plot_rank_hump_risk <- ggplot(df_tradeoff_focal_scenarios_bp) +
  geom_boxplot(aes(
    x = reorder(pretty_scenario_names,scenario_rank),
    y = relative_hump_risk_n,
    colour = factor(scenario_rank)
    )
  )  +
  coord_flip() +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  xlab("Scenario") +
  ylab("Relative reduction in risk to humpback whales") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(legend.position = "none")

png(paste0(path_figures, "/plot_rank_hump_risk.png"), width = 10, height = 8, units = "in", res = 300)
plot_rank_hump_risk
dev.off()

plot_rank_blue_risk <- ggplot(df_tradeoff_focal_scenarios_bp) +
  geom_boxplot(aes(
    x = reorder(pretty_scenario_names,scenario_rank),
    y = relative_blwh_risk_n,
    colour = factor(scenario_rank)
    )
  )  +
  coord_flip() +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  xlab("Scenario") +
  ylab("Relative reduction in risk to blue whales") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(legend.position = "none")

png(paste0(path_figures, "/plot_rank_blue_risk.png"), width = 10, height = 8, units = "in", res = 300)
plot_rank_blue_risk
dev.off()

plot_rank_both_risk <- ggplot(df_tradeoff_focal_scenarios_bp) +
  geom_boxplot(aes(
    x = reorder(pretty_scenario_names,scenario_rank),
    y = relative_both_risk_n,
    colour = factor(scenario_rank)
    )
  )  +
  coord_flip() +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  xlab("Scenario") +
  ylab("Relative reduction in risk to humpback and blue whales") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(legend.position = "none")

png(paste0(path_figures, "/plot_rank_both_risk.png"), width = 10, height = 8, units = "in", res = 300)
plot_rank_both_risk
dev.off()

plot_rank_DCRB_rev <- ggplot(df_tradeoff_focal_scenarios_bp) +
  geom_boxplot(aes(
    x = reorder(pretty_scenario_names,scenario_rank),
    y = relative_dollars,
    colour = factor(scenario_rank)
    )
  )  +
  coord_flip() +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  xlab("Scenario") +
  ylab("Relative revenue to\nthe Dungeness crab fishery") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(legend.position = "none")

png(paste0(path_figures, "/plot_rank_DCRB_rev.png"), width = 10, height = 8, units = "in", res = 300)
plot_rank_DCRB_rev
dev.off()

plot_rank_hump_risk
plot_rank_blue_risk
plot_rank_both_risk
plot_rank_DCRB_rev

# NEVER GOT THE FACETING TO WORK WITH THE FACETS ORDERED AS HUMP, BLUE, DCRB

# df_tradeoff_focal_scenarios_bp_pivot <- df_tradeoff_focal_scenarios_bp %>% 
#   pivot_longer(cols = c(
#     relative_hump_risk_n, relative_blwh_risk_n, relative_dollars
#     ), 
#     names_to = "response_metric", values_to = "relative_response") %>%
#   reorder(response_metric)
# 
# #response_names <- c("Risk to humpback whales", "Risk to blue whales", "Revenue to fishery")
# 
# plot_rank_rel_response <- ggplot(df_tradeoff_focal_scenarios_bp_pivot) +
#   geom_boxplot(aes(
#     x = reorder(pretty_scenario_names,scenario_rank),
#     y = relative_response,
#     colour = factor(scenario_rank)
#     )
#   )  +
#   facet_wrap(~response_metric) + #, labeller = response_names) +
#   coord_flip() +
#   xlab("Scenario") + 
#   ylab("Relative Reduction") +
#   scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
#   theme_bw() +
#   theme(legend.position = "none",
#         strip.background = element_rect(fill = "white", color = "white")
#      )
# plot_rank_rel_response




# ggsave(here::here(
#        "tradeoffs",
#        "Management scenarios",
#        "figures",
#        "Humpback_risk_reduction_effort_comparison_groupby_delay_method_boxplot.jpg"
#        )
# )

```
<br>

## Time series of expected (a) risk reduction by scenario for humps v blues, (b) $ reduction by scenario for all, sm, lg DCRB. order by whales


```{r}

plot_ts_hump_risk <- 
  ggplot(df_tradeoff_focal_scenarios_bp,
         aes(
           x = factor(year),
           y = relative_hump_risk_n,
           colour = factor(pretty_scenario_names),
           group = factor(pretty_scenario_names)
           )
         ) +
  geom_line()  +
  geom_point() +
  geom_label_repel(aes(label = scenario_label),
                  nudge_x = -10,
                  hjust=0,
                  nudge_y = 100 - df_tradeoff_focal_scenarios_bp[which(is.na(df_tradeoff_focal_scenarios_bp$scenario_label) == FALSE),]$relative_hump_risk_n,
                  direction = "y",
                  #xlim = c(0,50),
                  segment.color = "grey50",
                  segment.size  = 0.2,
                  na.rm = TRUE) +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  scale_x_discrete(
    labels = unique(df_tradeoff_focal_scenarios_bp$crab_year),
    expand = expansion(add = c(10,0.6))
    ) + 
  xlab("Crab Season") +
  ylab("Relative reduction in risk to humpback whales") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, hjust=1),
        legend.position = "none")

png(paste0(path_figures, "/plot_ts_hump_risk.png"), width = 10, height = 8, units = "in", res = 300)
plot_ts_hump_risk
dev.off()

plot_ts_blue_risk <- 
  ggplot(df_tradeoff_focal_scenarios_bp,
         aes(
           x = factor(year),
           y = relative_blwh_risk_n,
           colour = factor(pretty_scenario_names),
           group = factor(pretty_scenario_names)
           )
         ) +
  geom_line()  +
  geom_point() +
  geom_label_repel(aes(label = scenario_label),
                  nudge_x = -10,
                  hjust=0,
                  nudge_y = 100 - df_tradeoff_focal_scenarios_bp[which(is.na(df_tradeoff_focal_scenarios_bp$scenario_label) == FALSE),]$relative_blwh_risk_n,
                  direction = "y",
                  #xlim = c(0,50),
                  segment.color = "grey50",
                  segment.size  = 0.2,
                  na.rm = TRUE) +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  scale_x_discrete(
    labels = unique(df_tradeoff_focal_scenarios_bp$crab_year),
    expand = expansion(add = c(10,0.6))
    ) + 
  xlab("Crab Season") +
  ylab("Relative reduction in risk to blue whales") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, hjust=1),
        legend.position = "none")

png(paste0(path_figures, "/plot_ts_blue_risk.png"), width = 10, height = 8, units = "in", res = 300)
plot_ts_blue_risk
dev.off()

plot_ts_both_risk <- 
  ggplot(df_tradeoff_focal_scenarios_bp,
         aes(
           x = factor(year),
           y = relative_both_risk_n,
           colour = factor(pretty_scenario_names),
           group = factor(pretty_scenario_names)
           )
         ) +
  geom_line()  +
  geom_point() +
  geom_label_repel(aes(label = scenario_label),
                  nudge_x = -10,
                  hjust=0,
                  nudge_y = 100 - df_tradeoff_focal_scenarios_bp[which(is.na(df_tradeoff_focal_scenarios_bp$scenario_label) == FALSE),]$relative_both_risk_n,
                  direction = "y",
                  #xlim = c(0,50),
                  segment.color = "grey50",
                  segment.size  = 0.2,
                  na.rm = TRUE) +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  scale_x_discrete(
    labels = unique(df_tradeoff_focal_scenarios_bp$crab_year),
    expand = expansion(add = c(10,0.6))
    ) + 
  xlab("Crab Season") +
  ylab("Relative reduction in risk to humpback and blue whales") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, hjust=1),
        legend.position = "none")

png(paste0(path_figures, "/plot_ts_both_risk.png"), width = 10, height = 8, units = "in", res = 300)
plot_ts_both_risk
dev.off()

plot_ts_DCRB_rev <- 
  ggplot(df_tradeoff_focal_scenarios_bp,
         aes(
           x = factor(year),
           y = relative_dollars,
           colour = factor(pretty_scenario_names),
           group = factor(pretty_scenario_names)
           )
         ) +
  geom_line()  +
  geom_point() +
  geom_label_repel(aes(label = scenario_label),
                  nudge_x = -10,
                  hjust=0,
                  nudge_y = -25 + df_tradeoff_focal_scenarios_bp[which(is.na(df_tradeoff_focal_scenarios_bp$scenario_label) == FALSE),]$relative_dollars,
                  direction = "y",
                  #xlim = c(0,50),
                  segment.color = "grey50",
                  segment.size  = 0.2,
                  na.rm = TRUE) +
  scale_y_continuous(limits = c(-26,100),
                     breaks = c(-25,0,25,50,75,100)) +
  scale_x_discrete(
    labels = unique(df_tradeoff_focal_scenarios_bp$crab_year),
    expand = expansion(add = c(10,0.6))
    ) + 
  xlab("Crab Season") +
  ylab("Relative revenue to\nthe Dungeness crab fishery") +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, hjust=1),
        legend.position = "none")

png(paste0(path_figures, "/plot_ts_DCRB_rev.png"), width = 10, height = 8, units = "in", res = 300)
plot_ts_DCRB_rev
dev.off()

plot_ts_hump_risk
plot_ts_blue_risk
plot_ts_both_risk
plot_ts_DCRB_rev

```
<br>

## Tradeoff plots for hump, blues, both. Full time period, 2009-13, 2014-19. all, sm, lg DCRB.

```{r}

### 061220. summed normalized risk for both whales is calculated from the year_month df as part of the make_tradeoff_dataframes_function.R. this allows us to sum risk across year_months for each crab season and each scenario first, then calculate combined risk relative to sq

### normalized humpbacks
to_hump_n <- ggplot(
  df_tradeoff_focal_scenarios, #df
  aes(
    x=relative_dollars,
    y=relative_hump_risk_n,
    colour=pretty_scenario_names
  )
) + 
  geom_point(size=2, alpha=0.6) +
  stat_err(spread = "se", mult = 2, width=.1) + 
  stat_err(geom="point", size=7, alpha = 0.8) + 
  stat_err(spread = "se", mult = 2, geom = "errorbarh", height = .1) +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  ylab("Relative reduction in risk to humpbacks\n(normalized)") +
  xlab("Relative revenue to the Dungeness crab fishery") +
  ylim(-26,100) +
  guides(colour = guide_legend("Scenario")) + #,  shape = guide_legend("Scenario")) +
  theme_classic() +
  theme(
    title = element_text(size = 26),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 18),
    axis.title = element_text(size = 20),
    strip.text = element_text(size=18)#,
    #legend.position = "none"
  )

png(paste0(path_figures, "/Tradeoff plot - normalized humpbacks only_",today(),".png"), 
    width = 10, height = 8, units = "in", res = 300)
to_hump_n
dev.off()

### normalized blues

to_blue_n <- ggplot(
  df_tradeoff_focal_scenarios, #df
  aes(
    x=relative_dollars,
    y=relative_blwh_risk_n,
    colour=pretty_scenario_names
  )
) + 
  geom_point(size=2, alpha=0.6) +
  stat_err(spread = "se", mult = 2, width=.1) + 
  stat_err(geom="point", size=7, alpha = 0.8) + 
  stat_err(spread = "se", mult = 2, geom = "errorbarh", height = .1) +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  ylab("Relative reduction in risk to blues\n(normalized)") +
  xlab("Relative revenue to the Dungeness crab fishery") +
  ylim(-26,100) +
  guides(colour = guide_legend("Scenario")) + 
  theme_classic() +
  theme(
    title = element_text(size = 26),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 18),
    axis.title = element_text(size = 20),
    strip.text = element_text(size=18),
    )

png(paste0(path_figures,"/Tradeoff plot - normalized blues only_",today(),".png"), 
    width = 10, height = 8, units = "in", res = 300)
to_blue_n
dev.off()

### normalized both

to_both_n <- ggplot(
  df_tradeoff_focal_scenarios, #df
  aes(
    x=relative_dollars,
    y=relative_both_risk_n,
    colour=pretty_scenario_names
  )
) + 
  geom_point(size=2, alpha=0.6) +
  stat_err(spread = "se", mult = 2, width=.1) + 
  stat_err(geom="point", size=7, alpha = 0.8) + 
  stat_err(spread = "se", mult = 2, geom = "errorbarh", height = .1) +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  ylab("Relative reduction in risk to\nhumpback and blue whales (normalized)") +
  xlab("Relative revenue to the Dungeness crab fishery") +
  ylim(-26,100) +
  guides(colour = guide_legend("Scenario")) + 
  theme_classic() +
  theme(
    title = element_text(size = 26),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 18),
    axis.title = element_text(size = 20),
    strip.text = element_text(size=18)#,
   )

png(paste0(path_figures,"/Tradeoff plot - normalized humpbacks and blues_",today(),".png"), 
    width = 10, height = 8, units = "in", res = 300)
to_both_n
dev.off()

to_hump_n
to_blue_n
to_both_n

```
<br>


## Add in prioritzr outputs to tradeoff plot.

```{r}

prioritzr_outputs_all <- read_rds(path_prioritizr_all)
glimpse(prioritzr_outputs_all)

# 1) summarize outputs for each crab season, 
# 2) calculate risk relative to status quo
# 3) add result to tradeoff df and plot

  ### STEP 1
  
  # for each scenario df, (1) sum by crab_year (over year_month and Region) to get annual values for each crab_year, (2) join to metadata for scenario

prioritzr_annual <- prioritzr_outputs_all %>%
  group_by(year, month, target_rev) %>%
  mutate(
    crab_year = ifelse(month >= 11, paste0(year,"_",year+1),
                        paste0(year-1,"_",year)),
    risk_humpback_n = tot_risk_humpback*(1-ifelse(
      is.na(humpback_risk_reduction)==FALSE,
      humpback_risk_reduction,
      0)
    ),
    risk_blue_n = tot_risk_blue*(1-ifelse(
      is.na(blue_risk_reduction)==FALSE,
      blue_risk_reduction,
      0)
    ),
    risk_both_n = (risk_humpback_n+risk_blue_n),
    
    .groups = "drop"
    
  ) %>%
    group_by(crab_year, target_rev) %>%
    summarise(
      #target_rev = unique(target_rev),
      tot_risk_hump_n = sum(risk_humpback_n),
      tot_risk_blue_n = sum(risk_blue_n),
      combined_risk_n = sum(risk_both_n),
      .groups = "drop"
    ) %>%
    mutate(
      pretty_scenario_names = paste0("Prioritizr target revenue = ", 100*target_rev, "%")
    )

# any(is.na(prioritzr_annual$tot_risk_hump_n))
# any(is.na(prioritzr_annual$tot_risk_blue_n))
# any(is.na(prioritzr_annual$combined_risk_n))

### grab status quo

annual_sq <- annual_statewide_df_focal_scenarios[31:40,]

### STEP 2 make tradeoff df
  
df_tradeoff_prioritizr <- prioritzr_annual %>%
  arrange(target_rev, crab_year) %>%
  
  # STATUS QUO
  # define status quo values for outputs of interest for crab.year (note status quo value should be the same for each scenario)
  mutate(
    
    # hump_risk_under_statusquo = rep(annual_sq$risk_humpback, length(unique(target_rev))),
    # blwh_risk_under_statusquo = rep(annual_sq$risk_blue, length(unique(target_rev))),
    # risk_both_under_statusquo = rep(annual_sq$risk_both, length(unique(target_rev))),
    
    n_risk_humpback_under_statusquo = rep(annual_sq$n_risk_humpback, length(unique(target_rev))),
    n_risk_blue_under_statusquo = rep(annual_sq$n_risk_blue, length(unique(target_rev))),
    n_risk_both_under_statusquo = rep(annual_sq$n_risk_both, length(unique(target_rev))),
    
    # pings_under_statusquo = rep(annual_sq$Num_DCRB_VMS_pings, length(unique(target_rev))),
    # dollars_under_statusquo = rep(annual_sq$DCRB_rev, length(unique(target_rev))),
    # pounds_under_statusquo = rep(annual_sq$DCRB_lbs, length(unique(target_rev))),
    
    .groups = "drop") %>%
  
  #ungroup() %>%
  
  group_by(crab_year, target_rev, pretty_scenario_names) %>%
  
  summarise(
    
    relative_hump_risk_n = 100 *  (1 - (
      tot_risk_hump_n / n_risk_humpback_under_statusquo
    )),
    relative_blwh_risk_n = 100 *  (1 - (
      tot_risk_blue_n / n_risk_blue_under_statusquo
    )),
    relative_both_risk_n = 100 *  (1 - (
      combined_risk_n / n_risk_both_under_statusquo
    )),
    relative_dollars = target_rev * 100,
    mean_relative_dollars = target_rev * 100,
    
        .groups = "drop"
  ) %>%
  arrange(target_rev, crab_year) 

# add result to tradeoff df and plot

#glimpse(df_tradeoff_focal_scenarios_bp)
#glimpse(df_tradeoff_prioritizr)

df_tradeoff_focal_scenarios_bp_prioritizr <- df_tradeoff_focal_scenarios_bp %>%
  bind_rows(df_tradeoff_prioritizr) %>%
  mutate(
    prioritizr_scenario = ifelse(is.na(target_rev)==TRUE, "No", "Yes")
  )
#glimpse(df_tradeoff_focal_scenarios_bp_prioritizr)

df_tradeoff_focal_scenarios_means_prioritizr <- df_tradeoff_focal_scenarios_bp_prioritizr %>% 
  filter(pretty_scenario_names != "Status Quo") %>%
  group_by(pretty_scenario_names, prioritizr_scenario) %>%
  summarise(
    mean_relative_hump_risk_n = mean(relative_hump_risk_n),
    mean_relative_blwh_risk_n = mean(relative_blwh_risk_n),
    mean_relative_both_risk_n = mean(relative_both_risk_n),
    mean_relative_dollars = mean(relative_dollars),
    
    se_relative_hump_risk_n = sd(relative_hump_risk_n)/sqrt(n()),
    se_relative_blwh_risk_n = sd(relative_blwh_risk_n)/sqrt(n()),
    se_relative_both_risk_n = sd(relative_both_risk_n)/sqrt(n()),
    se_relative_dollars = sd(relative_dollars)/sqrt(n()),
    
    .groups = "drop"
  ) %>%
  arrange(
    -mean_relative_hump_risk_n,
    -mean_relative_blwh_risk_n,
    -mean_relative_both_risk_n,
    -mean_relative_dollars
  ) 

### normalized humpbacks, means only
to_hump_n_pzr_means <- ggplot(
  data = df_tradeoff_focal_scenarios_means_prioritizr %>% filter(prioritizr_scenario == "No"), 
             aes(
               x=mean_relative_dollars,
               y=mean_relative_hump_risk_n,
               colour=pretty_scenario_names
               )
  ) + 
  geom_point(size=5, alpha=0.6) +
  geom_errorbar(
    aes(ymin = mean_relative_hump_risk_n - se_relative_hump_risk_n, ymax = mean_relative_hump_risk_n + se_relative_hump_risk_n),
    width=.1
  ) +
  geom_errorbarh(
    aes(xmin = mean_relative_dollars - se_relative_dollars, xmax = mean_relative_dollars + se_relative_dollars)
  ) +
  geom_label_repel(
    aes(label = pretty_scenario_names),
                  nudge_x = -10,
                  hjust=0,
                  nudge_y = -20 + df_tradeoff_focal_scenarios_means_prioritizr[which(df_tradeoff_focal_scenarios_means_prioritizr$prioritizr_scenario == "No"),]$mean_relative_hump_risk_n,
                  direction = "y",
                  xlim = c(0,70),
                  segment.color = "grey50",
                  segment.size  = 0.2,
                  na.rm = TRUE
  ) +
  geom_smooth(
    data = df_tradeoff_focal_scenarios_means_prioritizr %>% filter(prioritizr_scenario == "Yes"), 
             aes(
               x=mean_relative_dollars,
               y=mean_relative_hump_risk_n
             ),
    se = FALSE,
    colour="black"
    ) +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  #scale_fill_viridis_d(option="cividis", begin=0.2, end=0.8, direction = -1) +
  ylab("Relative reduction in risk to humpbacks\n(normalized)") +
  xlab("Relative revenue to the Dungeness crab fishery") +
  ylim(-26,100) +
  #guides(colour = guide_legend("Scenario")) + #,  shape = guide_legend("Scenario")) +
  theme_classic() +
  theme(
    title = element_text(size = 26),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 18),
    axis.title = element_text(size = 20),
    strip.text = element_text(size=18),
    legend.position = "none"
  ) 

png(paste0(path_figures, "/Tradeoff plot with prioritizr, means only- normalized humpbacks only_",today(),".png"), 
    width = 10, height = 8, units = "in", res = 300)
to_hump_n_pzr_means
dev.off()

# ### normalized humpbacks
# to_hump_n_pzr <- ggplot(
#   data = df_tradeoff_focal_scenarios_bp_prioritizr %>% filter(prioritizr_scenario == "No"), 
#              aes(
#                x=relative_dollars,
#                y=relative_hump_risk_n,
#                colour=pretty_scenario_names
#                )
#   ) + 
#   geom_point(size=2, alpha=0.6) +
#   geom_smooth(
#     data = df_tradeoff_focal_scenarios_bp_prioritizr %>% filter(prioritizr_scenario == "Yes"), 
#              aes(
#                x=relative_dollars,
#                y=relative_hump_risk_n,
#                group=crab_year
#              ),
#     se = FALSE,
#     colour="black"
#     ) +
#   stat_err(spread = "se", mult = 2, width=.1) + 
#   stat_err(geom="point", size=7, alpha = 0.8) + 
#   stat_err(spread = "se", mult = 2, geom = "errorbarh", height = .1) +
#   scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
#   #scale_fill_viridis_d(option="cividis", begin=0.2, end=0.8, direction = -1) +
#   ylab("Relative reduction in risk to humpbacks\n(normalized)") +
#   xlab("Relative revenue to the Dungeness crab fishery") +
#   ylim(-26,100) +
#   guides(colour = guide_legend("Scenario")) + #,  shape = guide_legend("Scenario")) +
#   theme_classic() +
#   theme(
#     title = element_text(size = 26),
#     axis.text.x = element_text(size = 18),
#     axis.text.y = element_text(size = 18),
#     axis.title = element_text(size = 20),
#     strip.text = element_text(size=18)#,
#     #legend.position = "none"
#   ) 
# 
# png(paste0(path_figures, "/Tradeoff plot with prioritizr- normalized humpbacks only_",today(),".png"), 
#     width = 10, height = 8, units = "in", res = 300)
# to_hump_n_pzr
# dev.off()

### normalized blues, means only
to_blue_n_pzr_means <- ggplot(
  data = df_tradeoff_focal_scenarios_means_prioritizr %>% filter(prioritizr_scenario == "No"), 
             aes(
               x=mean_relative_dollars,
               y=mean_relative_blwh_risk_n,
               colour=pretty_scenario_names
               )
  ) + 
  geom_point(size=5, alpha=0.6) +
  geom_errorbar(
    aes(ymin = mean_relative_blwh_risk_n - se_relative_blwh_risk_n, ymax = mean_relative_blwh_risk_n + se_relative_blwh_risk_n),
    width=.1
  ) +
  geom_errorbarh(
    aes(xmin = mean_relative_dollars - se_relative_dollars, xmax = mean_relative_dollars + se_relative_dollars)
  ) +
  geom_label_repel(
    aes(label = pretty_scenario_names),
                  nudge_x = -10,
                  hjust=0,
                  nudge_y = -20 + df_tradeoff_focal_scenarios_means_prioritizr[which(df_tradeoff_focal_scenarios_means_prioritizr$prioritizr_scenario == "No"),]$mean_relative_blwh_risk_n,
                  direction = "y",
                  xlim = c(0,70),
                  segment.color = "grey50",
                  segment.size  = 0.2,
                  na.rm = TRUE
  ) +
  geom_smooth(
    data = df_tradeoff_focal_scenarios_means_prioritizr %>% filter(prioritizr_scenario == "Yes"), 
             aes(
               x=mean_relative_dollars,
               y=mean_relative_blwh_risk_n
             ),
    se = FALSE,
    colour="black"
    ) +
  scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
  #scale_fill_viridis_d(option="cividis", begin=0.2, end=0.8, direction = -1) +
  ylab("Relative reduction in risk to blues\n(normalized)") +
  xlab("Relative revenue to the Dungeness crab fishery") +
  ylim(-26,100) +
  #guides(colour = guide_legend("Scenario")) + #,  shape = guide_legend("Scenario")) +
  theme_classic() +
  theme(
    title = element_text(size = 26),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 18),
    axis.title = element_text(size = 20),
    strip.text = element_text(size=18),
    legend.position = "none"
  ) 

png(paste0(path_figures, "/Tradeoff plot with prioritizr, means only- normalized blues only_",today(),".png"), 
    width = 10, height = 8, units = "in", res = 300)
to_blue_n_pzr_means
dev.off()

### 061220. something is wrong (?) with the frontier created by prioritizr for both whales. it is way interior to the scenario expectations. might be due to the way i calculated combined risk above

### normalized both, means only
# to_both_n_pzr_means <- ggplot(
#   data = df_tradeoff_focal_scenarios_means_prioritizr %>% filter(prioritizr_scenario == "No"), 
#              aes(
#                x=mean_relative_dollars,
#                y=mean_relative_both_risk_n,
#                colour=pretty_scenario_names
#                )
#   ) + 
#   geom_point(size=5, alpha=0.6) +
#   geom_errorbar(
#     aes(ymin = mean_relative_both_risk_n - se_relative_both_risk_n, ymax = mean_relative_both_risk_n + se_relative_both_risk_n),
#     width=.1
#   ) +
#   geom_errorbarh(
#     aes(xmin = mean_relative_dollars - se_relative_dollars, xmax = mean_relative_dollars + se_relative_dollars)
#   ) +
#   geom_label_repel(
#     aes(label = pretty_scenario_names),
#                   nudge_x = -10,
#                   hjust=0,
#                   nudge_y = -20 + df_tradeoff_focal_scenarios_means_prioritizr[which(df_tradeoff_focal_scenarios_means_prioritizr$prioritizr_scenario == "No"),]$mean_relative_both_risk_n,
#                   direction = "y",
#                   xlim = c(0,70),
#                   segment.color = "grey50",
#                   segment.size  = 0.2,
#                   na.rm = TRUE
#   ) +
#   geom_smooth(
#     data = df_tradeoff_focal_scenarios_means_prioritizr %>% filter(prioritizr_scenario == "Yes"), 
#              aes(
#                x=mean_relative_dollars,
#                y=mean_relative_both_risk_n
#              ),
#     se = FALSE,
#     colour="black"
#     ) +
#   scale_colour_viridis_d(option="inferno", begin=0.2, end=0.8, direction = -1) +
#   #scale_fill_viridis_d(option="cividis", begin=0.2, end=0.8, direction = -1) +
#   ylab("Relative reduction in risk to\nhumpbacks and blues (normalized)") +
#   xlab("Relative revenue to the Dungeness crab fishery") +
#   ylim(-26,100) +
#   #guides(colour = guide_legend("Scenario")) + #,  shape = guide_legend("Scenario")) +
#   theme_classic() +
#   theme(
#     title = element_text(size = 26),
#     axis.text.x = element_text(size = 18),
#     axis.text.y = element_text(size = 18),
#     axis.title = element_text(size = 20),
#     strip.text = element_text(size=18),
#     legend.position = "none"
#   ) 
# 
# png(paste0(path_figures, "/Tradeoff plot with prioritizr, means only- normalized humpbacks and blues_",today(),".png"), 
#     width = 10, height = 8, units = "in", res = 300)
# to_both_n_pzr_means
# dev.off()


to_hump_n_pzr_means
to_blue_n_pzr_means
#to_both_n_pzr_means


```
<br>
