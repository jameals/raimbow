title: "Tradeoff analysis results"
---
author: "Jameal Samhouri"
date: "5/22/2020, 6/1/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This document provides an outline of figures and tables to include in the Samhouri et al. tradeoff analysis. It is based on the presentation I gave February 5, 2020, with improvements. See google doc: https://docs.google.com/document/d/15loTrgX2H7ZIArVmTIHVTNrinvHHui03CTLo1cdlbss/edit?pli=1. Use "Full workflow for risk assessment and tradeoff analysis" google doc to prep data frames for making figures below. https://docs.google.com/document/d/1T8S5rEOACMCeGa5efS5BnEQY4gOw-PbxmvILJvShsQo/edit

Current outline of figures:

Entanglements are on the rise coastwide. Hump, blue, other entanglements by year

The CA Dungeness crab fishery revenue, landings, and vessels by year. Also do for VMS vessels only

Maps of long-term average during DCRB season of hump, blue, DCRB $, DCRB lbs, DCRB pings [DCRB do all, sm, lg]

Time series of early season (Nov 15-Dec 15), mid season (Dec 16 - Mar 31), and late season (Apr 1 - July 31) long-term avg and SE in (a) humpback risk, (b) blue risk, (c) DCRB revenue. Emphasizes contrasts between times of year for each metric. [DCRB do all, sm, lg]

Time series of risk and revenue in cenCA vs norCA, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts between regions for each metric. [DCRB do all, sm, lg]

Time series of risk and revenue in and out of BIAs, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts in and out of BIAs for each metric. [DCRB do all, sm, lg]

Maps of long-term avg full season pings for SQ, delay cenCA, early closure statewide, and delay cenCA + early closure statewide. If not contrast, revisit.

Avg risk in 2009-13 v 2014-19 for blues and humps. 

Avg $ in 2009-13 v 2014-19 for all, sm, lg DCRB.

Expected (a) risk reduction by scenario for humps v blues, (b) $ reduction by scenario for all, sm, lg DCRB. order by whales

Tradeoff plots for hump, blues, both. Full time period, 2009-13, 2014-19. all, sm, lg DCRB.



```{r prep, message=FALSE}
# just getting libraries loaded and file paths sorted

library(tidyverse)
library(foreign) # read.dbf()
library(here)
library(lubridate)
library(sf)

# Note that Rmd documents set the working directory as the location of the document, rather than the project directory. 
#   Thus, please ensure that file paths are complete rather than relative

source(here::here("User_script_local.R"))
if (user == "SMW") {
  NULL
} else if (user == "JS") {
  #flag.save = TRUE # option to save all outputs or not
  
  path_entanglement_file <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Input_Data/Entanglement Data/Whale Entanglement Data/2000_19/2000_19.dbf"
  
  path_effort_shift_scenariocomparisons_annual_statewide_df_n <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/annual_statewide_effort_shift_scenariocomparisons_n_2020-05-19.rds"
  
  path_tradeoff_df_effort_shift_scenariocomparisons_n <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/tradeoff_df_effort_shift_scenariocomparisons_n_2020-05-19.rds"
  
  path_scenario_table_all <- "/Users/jameal.samhouri/Dropbox/Projects/In progress/RAIMBOW/raimbow/tradeoffs/Management scenarios/scenario_table_all.rds"
  
  path_scenario_table_focal_scenarios <- "/Users/jameal.samhouri/Dropbox/Projects/In progress/RAIMBOW/raimbow/tradeoffs/Management scenarios/scenario_table_focal_scenarios.rds"
  
  path_annual_statewide_df_focal_scenarios <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/annual_statewide_df_focal_scenarios_2020-05-29.rds"
  
  path_df_tradeoff_focal_scenarios <- "/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/Samhouri et al. whales risk/Output_Data/df_tradeoff_focal_scenarios_2020-05-29.rds"
  
  
} else {
  stop("Invalid user")
}

```
<br>

## Entanglement time series

Entanglements are on the rise coastwide. Hump, blue, other entanglements by year


```{r, include=FALSE}

# most code from Make time series of entanglements.Rmd
#Initial processing
entanglement_df <- read.dbf(entanglement_file_path)
glimpse(entanglement_df)

#Subset entanglement data frame to include only blue whales  
entanglement_df_blue <- entanglement_df[which(entanglement_df$Common_Nam == "Blue Whale" | entanglement_df$Common_Nam == "Blue whale"),]

#Subset entanglement data frame to include only humpback whales 
entanglement_df_hump <- entanglement_df[which(entanglement_df$Common_Nam == "Humpback Whale"),]


#x.whale <- readRDS("/Users/jameal.samhouri/Documents/RAIMBOW/Processed Data/5x5 Grid/Grid5km_whale.rds")

```
<br>

### Get annual entanglements

Blue and humpback whales
```{r, include=FALSE}
entanglement_df_blue_annual <- entanglement_df_blue %>%
  group_by(Year) %>%
  tally()

zeroes <- data.frame(
  seq(1982,2014,1),
  rep(0,length(seq(1982,2014,1)))
)
names(zeroes) <- c("Year","n")

entanglement_df_blue_annual_complete <-rbind(zeroes, entanglement_df_blue_annual)

# Determine annual entanglement rate for humps
entanglement_df_hump_annual <- entanglement_df_hump %>%
  group_by(Year) %>%
  tally() %>%
  mutate(Year.as.date = as.Date(paste(Year, 1, 1, sep = "-")) ) %>%
  complete(Year.as.date = seq.Date(as.Date(paste(1982, 1, 1, sep = "-")), max(Year.as.date), by="year"),
           fill = list(n=0))
entanglement_df_hump_annual$Year <- ifelse(is.na(entanglement_df_hump_annual$Year),year(entanglement_df_hump_annual$Year.as.date),entanglement_df_hump_annual$Year)


```
<br>

### Determine how many humpback entanglements occurred before 2014 vs 2014-2018
```{r}

entanglement_df_hump_prepost2014 <- entanglement_df_hump_annual %>%
  mutate(prepost2014 = ifelse(Year < 2014, "pre", "post")) %>%
  group_by(prepost2014) %>%
  tally() 
entanglement_df_hump_prepost2014
  

```
<br>

### Make some figures
Time series, blue whales
```{r}

myplot <- ggplot(entanglement_df_blue_annual_complete, aes(x=Year, y=n, group=1)) + # group=1 tells ggplot that there is only 1 group
  geom_point(size=2) +
  geom_line() + 
  ylab("Number of entanglements") +
  xlab("Year") +
  #xlim(1980,2020) +
  labs(caption = "Data from NMFS WRO, Lauren Saez") +
  ggtitle("Number of Blue Whale Entanglements,\nUS West Coast") +
  #scale_x_continuous(breaks = scales::pretty_breaks(n = 10))+
  #scale_x_continuous(breaks = seq(1978,2022, by = 5)) +
  scale_x_continuous(breaks=seq(1980, 20202,5),limits=c(1980,2020))+
  theme_classic() +
  #scale_fill_manual(values=c("lightskyblue", "coral")) +
  theme(legend.title = element_blank(),
        title = element_text(size = 32),
        axis.text.x = element_text(hjust = 1,size = 18, angle = 90),
        axis.text.y = element_text(size = 18),
        axis.title = element_text(size = 24),
        strip.text = element_text(size=18))
# print(myplot)
# #png("../RAship/vessel_profiles_final/yearly_DCRB_landings_revenue_CA_rawdat.png")
# png(paste0(root.dir, "Figures/yearly_DCRB_revenue_CA_rawdat.png"))
# print(myplot)
# dev.off()
myplot
ggsave("Figures/annual_blue_entanglements.pdf",width=10, height=8)

```
<br>

## The CA Dungeness crab fishery revenue, landings, and vessels by year. Also do for VMS vessels only

```{r}





```
<br>

## Maps of long-term average during DCRB season of hump, blue, DCRB $, DCRB lbs, DCRB pings [DCRB do all, sm, lg] 


```{r}

```
<br>

## Time series of early season (Nov 15-Dec 15), mid season (Dec 16 - Mar 31), and late season (Apr 1 - July 31) long-term avg and SE in (a) humpback risk, (b) blue risk, (c) DCRB revenue. Emphasizes contrasts between times of year for each metric. [DCRB do all, sm, lg]


```{r}

```
<br>

## Time series of risk and revenue in cenCA vs norCA, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts between regions for each metric. [DCRB do all, sm, lg]


```{r}

```
<br>

## Time series of risk and revenue in and out of BIAs, faceted by early/mid/late season and humpbacks, blues, DCRB. Emphasizes contrasts in and out of BIAs for each metric. [DCRB do all, sm, lg]

```{r}

```
<br>

## Maps of long-term avg full season pings for SQ, delay cenCA, early closure statewide, and delay cenCA + early closure statewide. If not contrast, revisit.


```{r}

```
<br>

## Avg risk in 2009-13 v 2014-19 for blues and humps.


```{r}

```
<br>

## Avg $ in 2009-13 v 2014-19 for all, sm, lg DCRB.


```{r}

```
<br>

## Expected (a) risk reduction by scenario for humps v blues, (b) $ reduction by scenario for all, sm, lg DCRB. order by whales


```{r}


#annual_statewide_df_focal_scenarios <- read_rds(path_annual_statewide_df_focal_scenarios)
df_tradeoff_focal_scenarios <- read_rds(path_df_tradeoff_focal_scenarios)
scenario_table_all <- read_rds(path_scenario_table_all)

#unique(sort(scenario_table_focal_scenarios$scenario_df_name)) == unique(sort(df_tradeoff_focal_scenarios$scenario_df_name))

# make nice scenario names
#unique(df_tradeoff_focal_scenarios$scenario_df_name)
df_tradeoff_focal_scenarios$pretty_scenario_names <- c(
    rep("Early Closure BIAs", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide, Early Closure BIAs", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA, Early Closure BIAs", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Status Quo", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Early Closure Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide, Early Closure Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA, Early Closure Statewide", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Early Closure CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay Statewide, Early Closure CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Delay CenCA, Early Closure CenCA", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Statewide 50% Effort Reduction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("CenCA 50% Effort Reduction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Statewide <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("CenCA <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("Statewide 50% Effort Reduction, <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year))),
    rep("CenCA 50% Effort Reduction, <30 fathom Depth Restriction Apr-Jul", length(unique(df_tradeoff_focal_scenarios$crab_year)))
    )  

### PICK UP HERE 060220. NEED TO ORDER SCENARIOS BY REL RISK REDUCTION

# consider mean_relative_hump_risk_n, which is the expected reduction in risk relative to sq for each scenario. set up for geom_boxplot
df_tradeoff_focal_scenarios_bp <- df_tradeoff_focal_scenarios %>% 
  left_join(scenario_table_focal_scenarios) %>%
  group_by(number_id, scenario_df_name) %>%
  arrange(
    relative_hump_risk_n,
    relative_blwh_risk_n,
    relative_dollars,
    .by_group = TRUE
  ) %>%
  ungroup() %>%
  mutate(scenario_rank = factor(number_id, levels=number_id))

#View(df_tradeoff_focal_scenarios_bp)

ggplot(df_tradeoff_focal_scenarios_bp) + #  %>% filter(scenario_category != "Status Quo")
  geom_boxplot(aes(
    x = scenario_rank,
    y = relative_hump_risk_n,
    fill = pretty_scenario_names
    )
  )  +
    
    
  #coord_flip() +
  #facet_wrap(~closure.method) +
  theme_bw()
# ggsave(here::here(
#        "tradeoffs",
#        "Management scenarios",
#        "figures",
#        "Humpback_risk_reduction_effort_comparison_groupby_delay_method_boxplot.jpg"
#        )
# )

```
<br>

## Tradeoff plots for hump, blues, both. Full time period, 2009-13, 2014-19. all, sm, lg DCRB.


```{r}



```
<br>